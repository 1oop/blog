+++
title = 'Ansible'
date = 2019-02-10T19:20:33+08:00

tags = [
  "运维",
]
categories = [
  "Linux",
  "运维"
]
+++

## 简介

### Ansible是什么？

Ansible 是一个开源的自动化平台，用于计算机系统的配置管理、应用部署、内部流程自动化以及持续交付。由于其简单易用且不需要在节点上安装代理，它成为了系统管理员和DevOps工程师广泛使用的工具。

### Ansible的优势和特性

- **易于上手和使用**：Ansible使用YAML（Yet Another Markup Language）编写自动化脚本，称为剧本（Playbooks），这使得它们易于理解和编写。
  
- **无代理架构**：Ansible不在客户机上安装任何额外的软件，通过SSH协议进行通信，这减少了系统的复杂性和潜在的安全问题。

- **幂等性**：Ansible的操作通常是幂等的，意味着重复执行相同的剧本会得到相同的系统状态，而不会引起不必要的变化。

- **模块化**：Ansible包含超过1300个模块，可以执行从系统管理到云服务等各种任务。

- **可扩展性**：用户可以编写自己的模块和插件，扩展Ansible的功能。

- **社区支持**：Ansible有一个非常活跃的社区，社区成员贡献了大量的剧本和角色，任何人都可以使用和改进这些代码。

- **企业支持**：Red Hat在2015年收购了Ansible，提供了额外的企业支持和服务，确保了Ansible在大型企业环境中的可靠性。

通过这些特点，Ansible提供了一个强大而灵活的自动化框架，可以简化和加速IT操作，同时减少错误和提高效率。

## Ansible的架构和组件

### 控制节点和托管节点

- **控制节点**：Ansible的控制节点是指安装了Ansible软件，并用于管理其他机器的计算机。它是执行Ansible命令和剧本的地方，但它不管理自己。
- **托管节点**：这些是由控制节点管理的服务器或设备。它们不需要安装Ansible，只需要能够通过SSH（Linux或Unix）或WinRM（Windows）与控制节点通信。

### 模块

- **模块**：Ansible模块是执行特定任务的独立脚本，例如安装软件、复制文件或者管理服务。Ansible自带了许多内置模块，可以通过简单的参数调用来执行复杂的任务。

### 任务和剧本

- **任务**：在Ansible中，任务是最小的单位，代表一个操作，如安装包、启动服务等。
- **剧本**：剧本是一个或多个任务的集合，它们按顺序排列，以YAML格式编写。剧本可以在多个系统上同时执行多个任务。

### 清单

- **清单**：一个描述所有托管节点信息的文件，可以是静态的也可以是动态生成的。它定义了要管理的机器，并且可以按组组织，以便于批量操作。

### 配置文件

- **配置文件**：Ansible的行为可以通过ansible.cfg配置文件进行自定义。可以设置的内容包括但不限于默认模块路径、远程端口、使用的远程用户和权限提升设置。

### 插件

- **插件**：扩展Ansible核心功能的代码片段。包括回调插件、查找插件、过滤器插件等。

### API

- **API**：Ansible还提供了一个API，使得其他工具和系统可以直接与Ansible通信，以便更好地集成。

### 界面

- **AWX/Tower**：AWX是Ansible Tower的开源版本，提供了一个Web界面和REST API，用于任务调度和运行剧本。


## Ansible的安装和配置

### 安装前的系统要求

- **操作系统兼容性**：Ansible可以在多种Linux发行版上运行，包括但不限于Red Hat, Debian, CentOS, macOS等。对于Windows用户，可通过Windows Subsystem for Linux（WSL）或在虚拟机中运行Linux。
- **Python**：Ansible是用Python编写的，所以它要求控制节点必须安装Python（Python 2.7或Python 3.5及以上版本）。

### 安装Ansible的步骤

- **使用包管理器**：在大多数Linux发行版上，可以通过系统的包管理器（如apt、yum、dnf等）安装Ansible。
- **使用pip**：Python的包安装器pip也可以用来安装Ansible。这是在MacOS或其他不直接支持Ansible的系统上的首选方法。
- **源代码安装**：高级用户可以选择从源代码安装Ansible，这允许访问最新版本并自定义安装。

### 基础配置

- **Ansible配置文件**：安装完成后，可以通过编辑`/etc/ansible/ansible.cfg`（全局配置）或`./ansible.cfg`（项目级配置）来定制Ansible的行为。
- **清单文件**：默认情况下，Ansible使用`/etc/ansible/hosts`作为其清单文件，但这可以在配置文件中更改。清单文件指定了控制节点将要管理的托管节点。
- **SSH密钥**：为了允许Ansible控制节点无密码登录托管节点，通常需要在控制节点上生成SSH密钥对，并将公钥添加到托管节点的授权密钥中。

### 首次运行和验证

- **Ansible命令**：一旦安装和配置完成，可以使用`ansible`命令与托管节点进行简单的通信测试，例如使用`ansible all -m ping`来测试所有清单文件中定义的托管节点的可达性。
- **Ad-hoc命令**：在编写剧本之前，使用ad-hoc命令执行简单的任务可以帮助新用户熟悉Ansible的工作方式。


## Ansible的工作原理

### 剧本和角色

- **剧本（Playbooks）**：Ansible剧本是自动化脚本，用YAML格式编写。它们描述了在一组托管节点上所希望达到的最终状态，包含了一系列的“plays”。
- **角色（Roles）**：角色是一种特殊的剧本，可以预打包为可重复使用的单元，以便在多个项目中共享。每个角色通常包括变量定义、任务列表、文件处理指令以及模板。

### 运行顺序和任务执行

- **任务顺序**：Ansible以定义在剧本中的顺序执行任务，从上到下。
- **任务执行**：每个任务通常调用一个Ansible模块，执行特定的操作，如安装软件包或启动服务。

### 错误处理

- **任务失败**：如果任务失败，Ansible默认会停止在当前托管节点上的执行，并将其标记为不可达。
- **错误恢复**：剧本可以包含错误恢复指令，如`ignore_errors`或`rescue`块，这允许Ansible在遇到错误时继续执行或采取特定的恢复步骤。

### 并发和批处理

- **并发执行**：Ansible可以并发地在多个托管节点上执行任务，这是通过“forks”参数在Ansible配置中设置的。
- **批处理**：可以通过定义“serial”参数来控制一次执行的托管节点数量，这在进行滚动更新时特别有用。

### 事务性和幂等性

- **事务性**：尽管Ansible本身不是事务性的，但通过使用剧本，可以创建类似事务的行为，如先检查后执行。
- **幂等性**：Ansible的操作设计为幂等的，即重复执行相同的剧本应当保证系统达到相同的状态，而不会引起未预期的变化。
